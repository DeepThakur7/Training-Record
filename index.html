
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Location‑Gated Microsoft Form</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: Arial, sans-serif; text-align: center; margin: 32px; }
    .status { margin-top: 12px; font-size: 16px; }
    .ok { color: #0a7; } .err { color: #c00; } .muted { color: #555; }
    .code { margin-top: 8px; font-size: 15px; }
    .actions { margin-top: 16px; display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; }
    .btn { font-size: 1rem; padding: .7rem 1.1rem; border-radius: 8px; border: 1px solid #999; text-decoration: none; display: inline-block; }
    .btn.primary { background: #106ebe; color: #fff; border-color: #106ebe; }
    .btn[aria-disabled="true"] { opacity: .5; pointer-events: none; }
  </style>
</head>
<body>
  <h2>Location‑Gated Microsoft Form</h2>
  <p class="muted">You can open the form only when you are at the specified location.</p>

  <div id="status" class="status muted">Checking your location…</div>
  <div id="codeBox" class="code"></div>

  <div class="actions">
    <button id="retry" class="btn">Retry location</button>
    <!-- Visible link; we toggle aria-disabled and href dynamically -->
    #Open Microsoft Form</a>
  </div>

<script>
  // ===== Configuration (edit these) =====
  const TARGET_LAT     = 22.36666; // e.g., Serilingampalli
  const TARGET_LON     = 87.359677;
  const RADIUS_METERS  = 5;       // strict radius
  const MIN_ACCURACY_M = 10;      // reject GPS fixes worse than 10 m
  const FLOW_A_URL     = "https://<your-flow-a-endpoint>";  // Power Automate HTTP trigger URL
  const FORM_URL       = "https://forms.office.com/Pages/ResponsePage.aspx?id=yXdC9f7aqkSFpHPVx8UkUBDlBp6oi0hGjvqBqX5Zo59UNTJEUzRYTTRRT0dGTDNRS1ZQWjRCNFpQWS4u"; // your MS Form

  // ===== Utilities =====
  const toRad = d => d * Math.PI / 180;
  function haversineMeters(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLon/2)**2;
    return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }
  function setStatus(msg, cls = 'muted') {
    const el = document.getElementById('status');
    el.textContent = msg;
    el.className = 'status ' + cls;
  }
  async function recordLocation(payload) {
    const res = await fetch(FLOW_A_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const text = await res.text();
    try { return JSON.parse(text); } catch (_) { return { code: text }; }
  }
  function disableLink() {
    const link = document.getElementById('formLink');
    link.setAttribute('aria-disabled', 'true');
    link.setAttribute('href', '#');
  }
  function enableLink() {
    const link = document.getElementById('formLink');
    link.setAttribute('aria-disabled', 'false');
    link.setAttribute('href', FORM_URL);
  }

  // ===== Core: check location and enable link =====
  async function checkLocation() {
    const codeBox = document.getElementById('codeBox');
    disableLink();
    codeBox.textContent = '';

    // Geolocation requires HTTPS or localhost and user permission
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      setStatus('This page must be served over HTTPS for location to work.', 'err');
      return;
    }
    if (!('geolocation' in navigator)) {
      setStatus('Geolocation is not supported by this browser.', 'err');
      return;
    }

    setStatus('Requesting high‑accuracy location… Please allow.', 'muted');

    let settled = false;
    const onSuccess = async (pos) => {
      if (settled) return; settled = true;
      const { latitude, longitude, accuracy } = pos.coords;

      // Reject low‑quality fixes
      if (accuracy > MIN_ACCURACY_M) {
        setStatus(`GPS fix too coarse (±${Math.round(accuracy)} m). Move near open sky and retry.`, 'err');
        return;
      }

      const dist = haversineMeters(latitude, longitude, TARGET_LAT, TARGET_LON);
      const inside = dist <= RADIUS_METERS;

      if (!inside) {
        setStatus(`You are ${dist.toFixed(1)} m away. The Microsoft link appears only inside ${RADIUS_METERS} m.`, 'err');
        return;
      }

      // Inside geofence → record location to Flow A
      const payload = {
        userId: "", // optional: set if you have identity; else leave blank
        lat: latitude,
        lon: longitude,
        accuracy: accuracy,
        timestamp: new Date().toISOString()
      };
      try {
        const resp = await recordLocation(payload); // expects { code: "GUID" }
        if (resp && resp.code) {
          codeBox.innerHTML = `<strong>Location confirmation code:</strong> <code>${resp.code}</code><br/><span class="muted">Enter this code in the first question of the Form (if applicable).</span>`;
        }
        setStatus(`Inside geofence (${dist.toFixed(1)} m, fix ±${Math.round(accuracy)} m).`, 'ok');
        enableLink(); // enable the Microsoft Forms link
      } catch (e) {
        setStatus('Failed to record location: ' + e.message, 'err');
      }
    };

    const onError = (err) => {
      if (settled) return; settled = true;
      setStatus(`Unable to get location: ${err.message}`, 'err');
    };

    // Prefer watchPosition for fresher mobile fixes; also call getCurrentPosition as backstop
    let watchId = null;
    try {
      watchId = navigator.geolocation.watchPosition(onSuccess, onError, {
        enableHighAccuracy: true, timeout: 15000, maximumAge: 0
      });
      navigator.geolocation.getCurrentPosition(onSuccess, onError, {
        enableHighAccuracy: true, timeout: 15000, maximumAge: 0
      });
    } catch (e) {
      onError({ message: e.message || 'Unknown error' });
    }
    // Stop watching after 20s to save battery
    setTimeout(() => { if (watchId !== null) navigator.geolocation.clearWatch(watchId); }, 20000);
  }

  document.getElementById('retry').addEventListener('click', checkLocation);
  // Run once on load
  checkLocation();
</script>
</body>
</html>
