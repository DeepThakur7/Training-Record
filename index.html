
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Location-based Microsoft Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; line-height: 1.7; margin: 2rem; max-width: 840px; }
    h1 { margin: 0 0 .5rem; font-size: 1.6rem; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 1rem; margin-bottom: 1rem; background: #fafafa; }
    .btn { display: inline-block; padding: .6rem 1rem; border-radius: 8px; border: 1px solid #444; text-decoration: none; cursor: pointer; }
    .btn-primary { background: #0a66c2; color: #fff; border-color: #0a66c2; }
    .muted { color: #666; }
    .row { display: flex; gap: .75rem; flex-wrap: wrap; align-items: center; }
    label { display: block; font-weight: 600; margin-top: .5rem; }
    input[type="text"], input[type="number"], input[type="password"] { width: 260px; padding: .5rem; }
    .hidden { display: none !important; }
    .ok { color: #0a7; }
    .warn { color: #c20; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>

  <h1>Location-based Microsoft Form Access</h1>
  <p class="muted">This page shows an <strong>Open Form</strong> button only when you are within the configured location and radius.</p>

  <!-- Status & Action -->
  <section class="card">
    <p id="status" class="mono">Checking your location…</p>
    <div id="action" class="hidden">
      #Open Form</a>
    </div>
  </section>

  <!-- Optional Admin Panel (remove this whole <section> to disable admin editing) -->
  <section id="admin" class="card">
    <h2>Admin Panel</h2>
    <p class="muted">Admin-only: update the Form URL and geofence. After login, your current coordinates will be shown and can be applied.</p>

    <div id="adminLocked">
      <label>Admin passphrase</label>
      <div class="row">
        <input type="password" id="pass" placeholder="Enter passphrase" />
        <button class="btn" id="unlockBtn">Unlock Admin</button>
      </div>
    </div>

    <div id="adminUnlocked" class="hidden">
      <p id="liveCoords" class="mono muted">Requesting your current coordinates…</p>

      <label>Use current coordinates as target</label>
      <div class="row">
        <button class="btn" id="useCurrent">Apply current lat/lng</button>
        <button class="btn" id="lockBtn">Lock Admin</button>
      </div>

      <label>Microsoft Form URL</label>
      <input type="text" id="cfgFormUrl" placeholder="https://forms.office.com/..." />

      <div class="row">
        <div>
          <label>Target Latitude</label>
          <input type="number" id="cfgLat" step="0.000001" />
        </div>
        <div>
          <label>Target Longitude</label>
          <input type="number" id="cfgLng" step="0.000001" />
        </div>
        <div>
          <label>Radius (meters)</label>
          <input type="number" id="cfgRadius" step="1" />
        </div>
      </div>

      <label>Optional note</label>
      <input type="text" id="cfgNote" placeholder="(not displayed to users)" />

      <div class="row" style="margin-top:.75rem;">
        <button class="btn btn-primary" id="saveCfg">Save Configuration</button>
      </div>
    </div>
  </section>

  <script>
    // -------------------------
    // Configuration (defaults)
    // -------------------------
    // If you remove the admin section, these act as fixed constants.
    const DEFAULTS = {
      formUrl: "https://forms.office.com/Pages/ResponsePage.aspx", // TODO: your form link
      targetLat: 17.533000,   // TODO: your latitude
      targetLng: 78.264500,   // TODO: your longitude
      radiusM: 500            // TODO: radius in meters
    };

    // Simple, local persistence for admin edits (no server). Remove if not needed.
    const STORAGE_KEY = "geoform_config_v1";
    const ADMIN_PASS = "changeme"; // TODO: set your passphrase

    const $ = (id) => document.getElementById(id);

    // Haversine distance in meters
    function distanceMeters(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = (d) => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function loadConfig() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return { ...DEFAULTS };
        const parsed = JSON.parse(raw);
        return { ...DEFAULTS, ...parsed };
      } catch {
        return { ...DEFAULTS };
      }
    }

    function saveConfig(cfg) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(cfg));
    }

    // ------------------ Main UI ------------------
    const statusEl = $("status");
    const actionEl = $("action");
    const openFormBtn = $("openFormBtn");

    let cfg = loadConfig();
    openFormBtn.href = cfg.formUrl;

    // Ask for geolocation
    if (!("geolocation" in navigator)) {
      statusEl.textContent = "Geolocation is not supported on this device/browser.";
    } else {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          const dist = Math.round(distanceMeters(latitude, longitude, cfg.targetLat, cfg.targetLng));

          if (dist <= cfg.radiusM) {
            statusEl.innerHTML =
              `<span class="ok">You are inside the allowed area.</span> Distance: ${dist} m (accuracy ±${Math.round(accuracy)} m).`;
            actionEl.classList.remove("hidden");
          } else {
            statusEl.innerHTML =
              `<span class="warn">You are outside the allowed area.</span> Distance: ${dist} m (need ≤ ${cfg.radiusM} m). Accuracy ±${Math.round(accuracy)} m.`;
            actionEl.classList.add("hidden");
          }
        },
        (err) => {
          statusEl.textContent = "Could not get location: " + err.message;
          actionEl.classList.add("hidden");
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    }

    // ------------------ Admin logic (optional) ------------------
    const adminLocked = $("adminLocked");
    const adminUnlocked = $("adminUnlocked");
    const unlockBtn = $("unlockBtn");
    const lockBtn = $("lockBtn");
    const passInput = $("pass");
    const liveCoords = $("liveCoords");
    const useCurrentBtn = $("useCurrent");

    const cfgFormUrl = $("cfgFormUrl");
    const cfgLat = $("cfgLat");
    const cfgLng = $("cfgLng");
    const cfgRadius = $("cfgRadius");
    const cfgNote = $("cfgNote");
    const saveCfgBtn = $("saveCfg");

    function refreshAdminFields() {
      cfgFormUrl.value = cfg.formUrl;
      cfgLat.value = cfg.targetLat;
      cfgLng.value = cfg.targetLng;
      cfgRadius.value = cfg.radiusM;
    }

    unlockBtn.addEventListener("click", () => {
      if (passInput.value === ADMIN_PASS) {
        adminLocked.classList.add("hidden");
        adminUnlocked.classList.remove("hidden");
        refreshAdminFields();

        // Live coords (best effort)
        if ("geolocation" in navigator) {
          navigator.geolocation.watchPosition(
            (pos) => {
              const { latitude, longitude, accuracy } = pos.coords;
              const now = new Date();
              liveCoords.textContent =
                `Lat: ${latitude.toFixed(6)} | Lng: ${longitude.toFixed(6)} | Accuracy ±${Math.round(accuracy)} m | ${now.toLocaleString()}`;
            },
            () => { liveCoords.textContent = "Unable to read coordinates."; },
            { enableHighAccuracy: true, maximumAge: 10000 }
          );
        } else {
          liveCoords.textContent = "Geolocation not supported.";
        }
      } else {
        alert("Incorrect passphrase.");
      }
    });

    lockBtn.addEventListener("click", () => {
      adminUnlocked.classList.add("hidden");
      adminLocked.classList.remove("hidden");
      passInput.value = "";
    });

    useCurrentBtn.addEventListener("click", () => {
      if (!("geolocation" in navigator)) return;
      navigator.geolocation.getCurrentPosition((pos) => {
        cfgLat.value = pos.coords.latitude.toFixed(6);
        cfgLng.value = pos.coords.longitude.toFixed(6);
      });
    });

    saveCfgBtn.addEventListener("click", () => {
      const next = {
        formUrl: cfgFormUrl.value.trim() || cfg.formUrl,
        targetLat: Number(cfgLat.value),
        targetLng: Number(cfgLng.value),
        radiusM: Number(cfgRadius.value)
      };
      cfg = next;
      saveConfig(cfg);
      openFormBtn.href = cfg.formUrl;
      alert("Configuration saved locally.");
    });

    // ------------------ If you want NO admin at all ------------------
    // Delete the entire <section id="admin">…</section> from the HTML.
    // The page will use DEFAULTS (or the last saved local values) and never show any config.
  </script>
</body>
</html>
